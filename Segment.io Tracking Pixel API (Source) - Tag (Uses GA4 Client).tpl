___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "categories": ["CONVERSIONS", "ANALYTICS", "ATTRIBUTION"],
  "description": "This custom template gives you the ability to post data to Segment's Tracking Pixel API source using GTM Server-sides GA4 client. The template automatically maps all events and user level data into the tracking pixels data schema. It auto hashes using base64 encryption and posts the required JSON object in the format that the API reads.",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Segment.io Tracking Pixel API (Source) - Tag (Uses GA4 Client)",
  "brand": {
    "id": "github.com_facebookincubator",
    "displayName": "Drumline",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEWCAYAAADcnKq+AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAC93SURBVHhe7Z0JmBxVuf7ZEVHAXUHcrgsi6kVFVExCV1XPTAC9onCRe/9XnysiuCBgyExVdc8060VlSaZ71mwz3TM9YZauXicrJGCW7lmTACEhgHhZVK4sgqySPPX/vtNnIEsFsvTe7+953qcnk56u01113v6+U+d85xAAdubM/qveMX1J/UnuqPllZcg42x0zLtKi5pVK1LhJsYwONaoPqVHjbnrcqFr64/T7v9K/d5DsvSpm2vS8V5So/iT9+xH623HVMu5UY0aYfg4oMaOR/n25Gje/q1meszTLe8p5Cd/7LhhoOlI2CwBQrcwYaDq2JmF8jgznXDXu+RWZRiuZRoLMZINi6U+xubiTXrt2xXV23crrSfyYVe3ya+2aJU22O9VoawmP0C7mtDeRaYnn0+u6hxvtmqU+ev1rd3v96+2aZT7xXDKzF+jvHqPHtfTYT4Z2sxI3f6xZxnQt5vvI6R2XHiHfDgCgUpge9R3vjulfd1NnpwipRYubK6QRvMrmUHcnGQaJzYlNxJ3yZo0lTqbhZDz5VsygY79pbLXcRjY1bic9spHS854nk72fDNfSYmaTEjXPo/fyL4jIACgz3HHPJyhC+jfqyL+lSGUlp2xsACKCEcZ0rTACERlxJONkGiUsNlI2M47ypt4TG68WM15W48YWSjvvUBPmFWqi8Rvu5bPeKT8WAEApoMVmf4THfkhzqDOPUKd+sXYZpVpsTpS+idStWNFSocRRGRnwzibGpkZp7p/IsKNa3PsbMrCvnYIIDIDCcn7/+YfVJszT3cnG2Urc4PTu7yJtmoo0khw5OXTqKhObtEgppwyMI8q45wEy9k41an6/NmJ+WH6kAIBcMm2V73DqcGepSe/v6XEjdcYdIoLi9I7HdGBQbys2MBGByciT0uFnKFW2lKT3B/wlID9qAMCB4LW9hypJ49tqwnMLmdT9nNrV3UVR1NKmyk/xCiA2ek4f+WYDRaXjylDDefKjBwDsK5TmfVFLeZvIpDZwSiNMiiIDrQwHyMtCFJ2KqRpLfZQymnMwXQKAt+HclH6CGtd/pEbNu6jTvJ6NpPjOF0yqUOI7qTNX38h3G4fP67z0GHlqAABTcDTlzqZ8j3FqwmNS9LNjh4IKo5l332grlhHzer2HytMEQHWjxr08wzw+FU1x6ufUeaDiiCMtV6ThBnm6AKg+Zgz84lgtYV6iJT0jYob5yusQTZWo3EkPD8rv0GKzvypPHwDVwVkp/QQtbvxGS3q3ilvqZFblOMO8qmQZYvqDYjUskacRgMoma1ReNqpHpu70OXYOqCQlJp7yEqCo/hV5SgGoPOp6fO8WEVUKRlXuqrvrBoq29N/KUwtA5TDN5ztcS3p+6k55HuQLHUZV/uKxRnocO8S25VkGoAKoSXj/TYt7xnncg2ei737hQ+UpTgkVS//7jIFrPiRPNQDlixIxT6eIKsYD6WJ9msNFD5WveByL7+RiHAuUNaqlv5cu5tvoYn6Noyrc9atMTRnW2UPGt+SpB6C8UBPei7MD6jdkS7k4XOhQZQiGBcqWGUPG58ioItlSwhinqgaJUs1kWq5kw5fkZQBA6aPFjF+7k97nkP5Vl3jQXbWMZ2r7jffLSwGA0sU1WH+qlvTeyUbF9ah4BrTThQ1VpvhGihI11snLAYDShVKBX7pT3md5pxanixmqfPE4pRIzrpOXBAClh9JvnshjVSKq4ioKiKqqUmJhetzc7op7T5WXBgClBZfJpRTwMbEkA3XSq1e8+Jmjq4g+KC8NAEqHab5ph2sxz03uJU3ZUrmIqpwVM7O3+vnuGUUgPCjNUSgvQxKiz46Xs+yipfL/SDwOyH/Dfyteo0RvYGR3tTZf5jvD8hIBoDRw9c76GEVVK8S8Kk4DHC7gqhHv78eGxFUKyGCyW8lnt8lisQHx/6mWvoO3s1cs4xnSE/TzVsXSH1Sj+kZShn43wuKf6bn38//Tzw/RMf6sRPW/03Fe5WOxMYhj3JXd1VlUXeW9FMkEhakVw9DomDM5uorqV8pLBIDSwDWou7UUpYA8XcHp4q1kcbREppA1pjd3hRambYmt4B+g591JRtRN5nOdEtMvU6MN39cSxnRl0PhizTLPR92RWR+YHr3y+Gmrmo5mOW2XxZs68P+dF/cdw7XrZ6Su+ZB7uecTrqj+FSViaGpE/w+eNkIG9ns65gC1aw0d/490zFfETkHSLN8wMjLUPd5LrkSfyTl338QlkhfK5gNQGlAHucqd8m7nqKEaUkCOVt6IaGS0RGZEkY65md5/TI2b19LzLlaS5hm8m3Tt8BVHyY+q4MwYaDp2RrTh40rMOFuzjJ/ybjaKZa6k9j3OpjK1OSqv4czJxrF0/jlVnbnqRltNGIt4H0jZFACKC3/j00Xfzhe8nBjofBGXuzjlovfHkYl4r3zHM2b+maKY5RSlXO+Omd9Th/RPXlBG27dPj/qOdyW9X+IdhrS4p4XeY4bSzX9MvUex01B8/9J6jtiyn4/3VXotQx4KgOLDKYyW8K7gb9K8phbFEkdRZEwi+uD0Lm48S7+/kyKVRjXpmVHTf/V75EdRMdREPR9VE+b3KdKaSwa2gQx5e/b9X0cRpTd7nulzEVGYUPamAafCPG6ZvRngXapY9WfIlwSg+My4w/iCO+nZzAO8e3T0chabFHc+jjDokTrvI1rCs8CdNH5QGzE/LN9+dWDbh6jR+tO0uP5LNW7wrkR/FeN0lDpyFMbKrgPVt9Pvt6gpb6sa9cyQf11SnN/ff1jrZM/X2ifCv/SnQ22BkdDiQDrU3zra2+NPB3/fNrb44sDGxZ+RTweVhDrYMENLef9aR9+6lZICcvTwZhpkPkxRw1x3wuN2L7/lnfJtVz1cBqgm6TtDsfQLXJb+Q3XIuFiL6d+hiPPzfCNAPq2kmJue/8HWicX1bePhjW0TffbCByx70dYoPUaEFvG/t1j2gs1DdutY78ukFS1jPT9ETdQKwTVYfyGlSS9VwuA6pzdivGbl9ZzWPEWmtZDeW517+SyYVAVAxvOzjsm+x7sfjNnz7h2wW0Z77UAmtFeRqQnjYiOjn9fOXbPwLPlSoBxRIsbPeEzHvaS8l9jw4LkYGBZjMp57uHa8Ejc+KN8mKHOaVrccS2a1uIsiqc6Ndzia01tqJCRMq31y8WvNmSDmj5UjWlSfxdEId/JyNavswDBFUwnPM6QOJWp8W749UCHctn7+e1pHw2u6t8XtlpEeZ0PaF6VDZFh9Il30r+9uki8PygHF0ps4IuEBVycjKHXxuJTYGTpu/lFLmE1awneyfGuggvDa3kPJaJaxWTma0AGodSwsxrzItK6ShwGljFbGZiXuZpFRqXFzszvh+cU3Y7PfJd8WqEDmruu+IZdmNaX2iT67c8Md2/1jvSjtXMooltFYjmbFt9pF3a2EZ5MS9/yktrl4s8xBYWgZ6f1y20T4dR44dzKdg5E/HRSD8f50aLJjrOMIeUhQSvDkyHIzq6m1cmrC+4hCEVU5zToHB0cg3W3xIHuAzMXJdHKhRVsoNcyE/kseEpQKYsyKb/WXiVlxO2V1iKe1lNdUBxqOk28FVAGBkeBnWkZ7X2sby310tbMW3D/EhrheHhaUAmcP6VeXk1nxkhEyqe1a3NvOC3zl2wBVhD8TvEZEVw4mk0u1jvXaraO92+eOhr4gDw2KiTLQcAlPXSh5s7Io/ZNr/LSk925X1PNN+RZAFRLIBJfwGJOTyeRaPM2hJR26XB4aFAsl0vA9MoEdYp6Vk0mUimLZagBa0vM3LW7+UjYfVClNq7qOJiN5+IAmiB6AeBwrkA61y8ODYqAMzv62e9j7Ii/6LdlJodSuqeJ47oS3f1r/rE/I5oMqpjnTc5I/HXyOpx44GUyuxeNYdLy4PDwoNDVx/V8oBXyKi7eVrFnFjOxSmqT3L0rU/LFsOgBiwN2/PvhaPqYzOGn+fYN8p3C1PDwoJFzPSUuY94nJlZbubBbFFI9VySoKasIT43rxsukACNpGw58MpIMvFcqwFrBhpUPL5OFBoeBlDBS5LBVbcJVoZMVF8yiqelmJGb+WzQZgF9rWhE8gA/lzx4bFjgaTa/GiaHpcLA8PCoUabfDXcc1tB6MounhgnedVDTdOonIleDv8meD4/HsH9jCXfEhMHk2HrpWHBoVAHdIvlYuBnQ2jWOIUUJZ+0RKe0OmdmAAK3h5KCdt5uoGTweRSXP2BjdGf7q6Thwb5ZobVcJY75X2Nl7E4mkaxxHcBudpnyrtdjelXy+YC8Lb4Mz3n8GD4QZWT2Qd1TC5ms/pr53gnvkgLgdJnfFBLmI/WLL+25MateOCfTPQvakSvlc0FYJ+4df2t76Ao66F59/Y7Gk1uFLS7HozxlIaAPCzIN0rUWJIdZC+tO4K8MzClgBtc/bM/K5sKwH7RnO6+PJ/Lc7gefNtY+BWeRiEPCfKJMlTfNHMVmZWDYRRLvBmpaFPcTKlB/b2yqQDsN00DA0fy4DvfxeNyME6mczAKbovbzeuD18vDgXyiDBlnu4e928Wuvg7GUQzxgH+2woI5/5Dz99ySHYD9RdTEmux7USzTyZFpsfl1PciRW8/a5uFm1FXLN7w1E5nDozXLSmfcihdXi8mglv5b2UwAcsLc9V0XdG7qtzvItHIRafHdx9bx8Nbm1fNOkocA+YRMoU+kXaViVnK7d5dlNMgmApBT5q7ruqh9su+lhZvFJM8DEm8J1r0txtt9bbxl3QKssCgE6mD9j8R8q1gJzLfiOVYpMivefDVmoKA/yCu33TP/jPYNd4zynb3Ojft+97BltEeUQ+ZpEq0T4a62NW0nyJcE+URLNJysJcxnuW6Uo4EUWGxWoi2WgVpCoCBcMdx8VPtE3+y2sfCjU7s8s3nxusNWiqDYnPiRKz3wRqt8l7Fjwx12x2TfqtZMzznyZUAhUCw9yXvwlUIqKNJAiqyoTZfJ5gFQMJozPe+mFPGH7RPh3paRngf8mdALbFRTC6bpd0+1ZHpGW9Kh21tHw9Pln4FCoVoN/y12jSmBVJAH2HnMSo00IA0ERWeVverwlnW9HwusX3Rax1jvaWRmn5+b7sOu38VC6TdP1OLm06WQCmpxT3a7rSFdl80DAIA3USINd5REyRhZcQFTFwAAjpA5nFu73FcSVRh4KoUSNRbKpgEAwJuc2X/VO5So/mAtTxB1MJBCSkRWMWPZ6R2XYpdcAMCeqFHdW/S1gpSG8rwvNWHed1ZYx/wVAMCeuKxrPkVp4ItF3aKLzKpmaRPPt/obqi4AAPaKEmlYXOw5VzzXisxqu8vS3bJZAACwK66YZ1rNcFNxB9rFHcHrbddQwzWyWQAAsCdKxFhXx+vznIykEKKoTtwRtAzsJAIA2DuaZVwo9hQs1ox2MiuexU7R3Za6Jb53y2YBAMCu1A5fcZRq6feLZS9OZlIA8Q437lTjK2pE/5psFgAA7IkWbbhEDLQ7GEmhxMc/e6geO9wAAPYOR1eKpT/I22I5GUnexfOt7ryeqy8slU0CAABnFI6uuMSwk5kUQDVLmnjjiKenR+pRNhYAsHey0VXDtmJFV1y9VAz0D9b/SDYJAACcUSLFja54nSAZZkw2BwAAnOHFxGpEv79mWXGiK1FjK27+fUa04eOySQAA4Iwabfi+2MTBwUwKIXFXMqJfIZsDAAB7h1KxNbUrijPvStZkH/Xa3kNlcwAAwBnN8pzlXtJYlC27uNSxO+Xd4R4yviWbAwAAe4eMI1yswXYx0D6kd8umAADA3uFBbi1uvqQlCl/vyp3KDrTzPoeyOQAAsHcUq+G6mVx22MFQ8i05jaFRNgUAAPYO12pXLf1RMbvcwVDyKXnMx9WBhuNkcwAAYO9olnF+7XIuIeNsKvmU2Ewi2vAr2ZSq4Pz+/sP6IaicZPcfJi/f4kPRVVxsRupgKPkUL/1RLGMbR3iyKRVJc6b7K4GRnqtbR3t6WjKhdYFMz72BTBCCykb+dOi+lrHe0cBIKNUyFr6pc3Jx3e/WLniXvMQLhzqkf5Iiq1eKMdjOu98oUeMnsikVR9to+KK28b67W8d67a6tUXvhAxF7/n2D9rxN/RBUfrp3wF5w/5C4lufTz3Rd/7F1PHz971d3fUhe8vmHDGN2Ni1zNpV8iXe/oWM/XDvcfJRsSsVw292LTmuf7LuLDYpPcOtorx3IhCCoYtQy0mN3brzD7n4wZrePh5/wrw8VIPCw7UMUS58oxsaoYglOrPKW4Mxd13VR++Ti5xdtscRJdTrZEFRJ6tzYT9mDxRFXh2+V73DZFXKPFjO/qiU8Owq9Gw4vcFai+pPfic0ufA6cR+as6f4vPnksfzroeHIhqBLVQllE8KE4f0kP5m2AXrX03xYjHZTH9MlmVAT+9UGVIqsdHRsW2wGYFVSNooyie1ucvqy722S3yB3n959/mBLRNxe6SB9vKqHFjBeUfvNE2ZSyp/kPC9/fOtrzxPz7BhBZQVUtHq/lsVvqB/8uu0du0CLmmcI8CpwOijrtkYYu2YyKoHlddxsPPgbSzicRgqpJfEexJRN6Ys6GruNlFzl4KB28udDpIJujO0UmGak/Uzaj7GlZH/oXyt9faxvvczx5EFSN6qIvcH8mmJtd2mU6uKnQ6SDvb6hY+nrZjIogkAle37WVoiuHkwZB1ap5mwbs5vXdW3mWvOwqB44yaHxRjZvbi5MOGj+TzSh7fKtWHU65+iaeUOd00iCoWsVTejo23GG3pru/KLvLgaPFjJ+KXWkcTCVfEiVkosbT0xO+98lmlD1z0+FP08n5Z+tY2PGkQVA1i+ciNo/0XCK7y4GjWMbcQhfqE9FV1KiowfbASPDcTh5gxARRCNpD4m7h+mCr7C4HjhrV+wu62DlmioXOLkt3yyZUBP5M6CcLN0dgWBDkIF43G8gE47K7HDiq1ZAq5M44ouaVpT8ybVXT0bIJFQGdlFm8EHT3EwVBUNawWjKhhOwuB06hIyyePqFY+m3y8BUDnZRLEWFBkLNyF2HFjNsLNYbFO/Bk1w4a35aHrxhaxoLfFZPkYFgQtIf4y9yfDnbI7nLgcA0qrkXlZDC5FqeDSkR/pHb4ioorI+MfD38uMBJ6netdOZ0wCKpm8V1CevyF7C4HjjtifEGNG9t5L0Ank8mlsmVkzHZ56Iqi6f6BI/3p7q18p3D3kwVB1SzOOrhfNGfCX5Hd5eBQrIYRnnnuZDI5E98dXOaz3RV2d3Bn/JngHMx0h6BdxSWWAunuPzUNNB0pu8rBoUTNS/K9llAsxYnom07vuPQIediKI7C+97TWsfDrbZg8CkFviIsB+NPBm2Q3OXh+kN3aa0tNvqKsmJwsGjMukoesWJrTwTAv9kQdLAgKiSU5LaM9zwQmFnxEdpHcoMb1Wk7ZtESOx7Is3eZNWV2WvlweqqKZk+76eOtY79+zYbDzSYSgahCPXfGXd/O6roMfbHdCjTT8dubqG8V4k6P57K/IrGpXXEsm6H1SG6ieref967p/yBtOtI0jNYSqV93bxHjukOwW+UGJGj1sWgd919AyhFm5U95nZ1RQzat9hUzLs2hr1G6f6EN6CFWduDxy62jPmls2ht4pu0Se8HoPVePmHF6uc6A1srhUzcxVZHpJ76NnD876unzlqiOQCV7ZMbl4R3aWr/OJhaCKUTokvqClWSU6V3YeJ7tC/iHjudg93Pho3aobsuv/9iFN5KiMS9WIsbCUp+9bfbNzO9BWhgTWBWvaJvoe4DslqOYAVaroGhebqrZP9r1E17iXOFR2gcLB9arcSa+XIqWHONriiZ9TkRebGC+zEb8nk+K7gFrS87qWMFeQuZ0jXwIQvI1362jvLDqpWznaErvl0iPfQWmfXCy+lSConESZg6gkyjPY5T6Ez3dM9i2auy70BXnZFw93aNY7tWhjjZrw3ExKKpY+qVrGNsUynuCfKbIa1FKNs+qWGAdfUbCC8Y13HtM20nsuhctz28Z6V1MI/afASM9f/engc/Qt9SwElbr4WvVnQn8jPUGR1ERgJBRuGev5Gd8dl5d5aXLKQNORP+i/9R2H2PIXYL9pWtV1dOf4wHGBib6PdIz1fBiCSl18rfJWdp3xzmPkZQwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAyuWUgaYjLyDJf5Yq9iEtY31fb51YfHVLJtTVkulZGkgH7/Gng3dDUFkoE2KtahsP9wcyPbcERkIXtK/vPlFe4GAv1KQav6IlPYaaMIeUqDGqRo1t9PgwaUKLeyJawtOoJhq/IZ9eXNrWtJ3QOt47q228b7J9os9etMUSWnD/kD3/vkEIKjstfCDyxjXcMtLzbOtEuNe/vvdb8pIHEjXu+ZE76V2vJb123Z3X23Urr7NrlvrsmiVNtpvEP/Pv+P/cw422lvKM0d9cfkrTBcWJvuhkXkgm9XDXgzF73r0Ddstojx3IhCCoYsRfwl1bouKxbbx34a2rO98nL/+qRYnMPp1M6m42otrl19pa3LQpqnpLaTHTrl1GBnbXDTZFXGOuoYZp8uXyj8/nO7x1tMe/cHPEnrdpwPFEQ1AlqXWs1+6mL+b2yb5tt93TfYbsClWHa6j+YveSxufZrJyMaV9Uu+I6jrhec1n1l8uXzR/9/f2H+Ud6BoMPxe3W0V7HkwtBFal0yF6wechu37D4udvXLvq27BJVgxJpuISjJE73VMvZjPZJ9LfuVCMZ17W2K9JwlXz5/NC8LtjOZkXpoPNJhaAKlj8dFONcbePhp9tGez4ru0XFo0TqNfewdzuPRR2UWe0kHvvilFKJGD+Qh8kt/nTPf/JgZAsiK6iKxaa1kPqBPx0a7RjrOEJ2j4plesL3PjVmPsbmkiuzEqLXqlnaxGNaz7iGPB+Th8sNgZHge+lkPdW5qd/xJEJQtYlvNjVnumfJLlKxuKKGf+bqG3NrVlOydHvmXTfwY588XG4IpIM+PkGcxzudPAiqNnVuvIP6Q/CptjXhE2Q3qTjccc8nKLp6xU3pm6Ph5EAUYVF6aG5X4sYX5WEPjubh5qP864OPiRPkcOIgqFrFQyT0eKnsKhWHZulNIgJyMJpcSkZZAXnYg4PSwW+IeVYYaIegXcRTeyjrWCa7SsWhWPpEzTKfo8nkUjzZVLGMh3lZjzz0gUMnpF5+k0AQtJPaJxbzIPwznePhiptQWjvoPVWNm6/vy8TQg5UW99hqzNiuDOYgLSTD6udlCk4nDIKqWXzHvG08bLeO9nxNdpeKQbVM/WAmiO6veF5WTqY4tGRCox0bMH4FQbuLh0n4znlLJvhd2V0qBkrRRmqW5z8dnBKvO1Rixq/l4Q8cOhnjMCwI2lNsWNlF0qEfy+5SEbji9adSKliQdHBKbFgc1ckmHDiBdPcEDAuC9hQb1vx7B3gc699ld6kIKLpqrLurcOkgS0RYUf1K2YQDx58JLeWT4nTCIKiaxYbVPrnYDqS7ZsjuUvZMW+U73BVpuJ/LwzgZS77Ei6IpJTz4MSx/JngzL0VwOmEQVM3iAXd/OvTy3DXBk2V3KXu0hDHdPdxkq7HCpYPiLmE8R5NHm0dD53FRM6cTBkHVLJ6f6E93T5zf33+Y7C5ljxIxugp5d5CVnYfVsC0npZXb7g2fQCfnBS5itvsJg6BqFi9X86e7bpJdpexxL/d9gAzkGXcqf0txnCQM0tLbZTMOnkA6GO7aGsVaQgiSEvOvxsKvzUkHT5HdpOxRIvqVhY6uOPXk2fRaVJ8pm3HwNK8L/mvbRPh1PklOJw+CqklcYoYrkPozwYWyi5Q9PNhOhnUfF+lzNJY8iWts0XGfmDHQdKxsSm6Yu667uXtbzPEEQlDViLIMMVl0rOeZ5kzPSbJ7lD2KZdbVLLu2oIPtLI7oFMvIvfHfsjz0zpaRngmxrpC+YRxPJgRVuDjLWHD/oD033XWR7BoVgRJpWFbLkzcdTCVvihl2LZtkxDxHNiO3NK/t/hSdsMcWPcCm5XxCIagiRdd723ifzWO5/nS3R3aJikBNNH7NnfJuL+TMdpa4OxjR//e8uO8Y2ZTcM2ftgs+2TfRt4vQQG1FA1SKePD2PUsHmdHe97AoVA0VXiws+2E7ibb+UqDFXNiN//M/KwHtbx8NBPolcEwh13qFKFS9Lk1t8PRRId39HdoGKQYkZn9eS5qtc+dPJVPIl3qtQTJ+w9MLtCu1P99a1TfatpJMpQuX5lNvzCebQmfdy4whMPEJQqYtLxYyFxVIbjqQWPmCJXaDpd0+0T4R9t62f/x552VcUakQP1d2Z/6qiu4vHrhRLn/R6vYfKphQO/1jvtwIjoRvpG+luenzUnw6+QDn/jt2/rSCoZDUiHl8hPUUZw8Z2yiBI/1GpRsWI6Crhea3Q0RWLTVKLGr+RTSkeC7bE3tU6uuijgZHgZ3jvtjlrIaj0xdfq7WsWfrJtXegDtm3Lq7myoQintxhjV3JTixenR+orZloIACCPaIPmV8k4doiFxw6mkk+JuVcR/Q7ZFAAAeGsUq2GJKJrnYCh5FS/FWdpkuyIel2wKAADsnbMj9efUcvnjAs9qZ2W3p9cnvXYRBtsBAOUFb6WlWPq9Yut5B0PJt0Q6GDV+JpsDAAB7R4vqV/KETSczybd4obNq6X+ZHvUdL5sDAADOKEnzRDXueUYYh4Oh5FVWdmY7/XyDbA4AAOwdJdIQLlp0xVMZYsaLNdHffFQ2BwAAnFFj9eeIQnkFXuA8Jd6FR7EaOmRzAADAmboe37vJNB4pdHG+KfFMejGj3qqvmOqsAIA8oUTqW2cWKRXMjl2J6KpHNgcAAJw5e6i+hutOFWNGO0tEV0nva65B76mySQAAsCfnpvQTtLj5KI9dOZlJIYToCgCwT5BhhGeuKlIqSMpGV55XEV0BAN4S15B+qVgrWITlN0Jy3hW1Y55sEgAA7Ikr0vAlLen9hztVhAmiUmLeVdzzj2n9sz4hmwUAALvC+/tRVHVf7QqKrijKcTKTQqiOU9Eh/WbZLAAA2BPVMvuEWTiYSKHEdyXVmPHkWSn9BNksAADYFdXSdbH0pljjVlI850ux9MtkswAAYFdcEf07Yr5VEeqz76zaFWJziQne+l42DQAA3kQdbPhXd6rxOTenYkUct+J1imJz1CHjbNk0AAB4E6X/6hPVpPmIKMhXRLOamsagDGGSKADAAXWg4TiKakbEzjeW7mwkBRLX2KJ09G9abPZHZPMAACALjxFpMXNJsepb7S6UPgYA7BUyiaIuu3lDnAqyWVnGKtk0UCz67f7DmrcNH9UxNnaE/BUARYdMYt7M1TfyXCdnEymg3Ckv6yWsFywCc9N9H+yYXHxx20Rfiz8T+kPLaM/mQCb0IGmLPxNMt471zqP/++/O8YGT5Z8AUFDUqBkQta2KPNdqSmLO1ZAxWzYPFII5ows+2zbe106G9H8LN0fsRVsse/59g3bnpn67c2NW/G/+/cIHInbbePj51olwr38sfIZ8CQDyjhIzWtggilXmeBdxKrjyOp5ztRZ7DBaQwGiv3j7R93zXgzG7fXKxTdHU24rMze7aGuXnv9Y60fe7plVdR8uXAyAvZM3qelsrkciKF1ZrSc+LNQnjc7KJIJ/8LrbgXW1jvVb3lFGlnc1pr6LnU6Rldz8UtykyW3frPYuwGwjIPTbvJWj08JhVqZgVp6M80O4aqr9cthLkk9+tXfCu1rHwyiCZTctIj7Mh7YcWUbRFpvUQTAvkkvPivmO0uMcqhfWBb0rPjltF9SHZTJBv/OuDMTYrJ/M5IKWDlCJadstoz+gtG0PvlIcB4ICZMXDNh7SEeY+ovFACdwOFLMOWW4U9dtYS4/2yqSCf+Nd3X8VpYC4iq90V3Ba3/elgQB4KgAOCt8NyJz2buR66o3EUSVrSyzPat7v6G1yyqSCfzF0TPLl1tPeFjn0cXN9ftY2Fs+NhI8GvykMCsF+4Ld3tTnqf4qoHHNE4GUdRRFEeT1RVLN2UTQX5xp8O3c7RlZPZ5ETpkJj6QFFcVB4SgH1GjZo/d6e8/6xZWtyqC3uIpzBkx61wXReKOau7jqd07amODfmJrqbUSlFW62jPP+es7fmsPDQAb8kFA01HqglvK89r4pnjpWZWohJEzNxWs+zq98gmg3zjXxf6twX3DVK6lvuxq93FA/D+TOgqeWgA9sr0odmfJjNYw+lWSUwI3U2iCkPK+6ISmX26bDIoBGQkt/Bkz93NJR/i2fCBdNCShwbAEXdcv0Dj8aqVpTW4PiWuXsp3BZWB+otkk0GhoIgnteD+IUeDybXmbeqnx+C9WLIAnDjz1qve4U54bq9Z6stu2FBKKeCUYuZUbfYm2WxQSMiwRudvGtjDXPIhHiej4z3B42by8AAIFKv+DHfKO8Lzq7R4ceuvv5VE6RrLCMpmg0Ji2zalhMEHeRGzk8HkWjy1wZ8JPn37WM+HZRNAteM95FAl7jG0lPdVsWegg0mUisQC66h51ykDTUfK1oNCQwYyNq/QEdYGRFggG1WpSe8feCKo2BG5FFNAlqXbtby9fcJz7/SE732y+aAYFHoMi453n9eLMaxq5pux2e+i9O9G93DpR1XCrJZfa2sJ7+PqkP5J+RZAsWjJhG4t2F3CzRGe7Y67hFWMEtcvcCcbN/OES7FXYKlGVSyea8VrBJOeZ2dEr/myfAugmARGer7HEVY+1hDurkVbonSc3t/IQ4MqQkmYp1PHj7MB8JQAR4MoJZFZ8cx6igRfUAZnf1u+DVBsbl4TPsGfDv5fIWa6t4z2vO5fF0ZhsyrCNeT5mJrw+MmsXuUZ6yVTu+qtxGbFu0WnGl9RrdnnyrcCSoVAJjiXK4vud7G+fRWvJXzA4ooNcXlIUOEofb/+oDvp8VHa9/Qb6Z+TOZSadjErHWZVirRvWPzxltHeF/e1FPL+qnWs1+7YcIc9Jx36ujwkqFDO6jfeT0Y1W417nmSjEmsAnYyhFCXNyj3c+LIy1HCefEugFPGvD17TvY2irDyMZXVvi9vN6e42eShQgShJ80Q1G1H9mcsE81o7R1MoVcGsygybB+BDSTYXJ9M5IMmyMoHRnsmW1QPHyiOBCkKN1p+mxcxmLen5m4ioys2oWJYuBthrhhtfglmVEZ0rO49rG+tdzRVCHQ1oP8V3BdvG+x6Zk+76uDwEqACm+XyHKwmzjtK9fjVhviomfpZT6rez5Dwrav9zrggqhpYdv82aVlLsmjPRt/8D8fR8viPIkVrbRF/Gf0/oE/KlQZnjsjyfcsc9symi2sgLlMVdv3IZTHcSpYE8cVVLev+sRerPlG8TlCOUxjWS4bwo9hlk43Iyp93E23txCkh/t6NtvLf5luW3YOOJMmd61He8O9V0gTvpGVLjnn/w+BSbVensVnPgEmNtCc+DrsF6bCdfCTRnFn6ezGd+y2jvc1zL6o2dnzfeIe76sebdOyB+L4xqrPclMq2BwEjwG/IlSopzU/oJNUnfGS7LuFCx9Ms0y/ipFjfOd6d8X56xugljbBL+nNyJxvMoelpAepyjEBFNJcs4mtpNojBg0rt2eqT+JPm2QaXQOrroo+3jvT8OjIQWUCS1xp8OPUw/P0o//5GUaRnp6e7Y2HdZezr8afknJQOvrFcTnn8XEULC8ySnMDzTmr9dp6IFnsxIv/8jKaQmvBdriYaT5Z9XDbxOjiKoH7kTZpinJEx9RryTsVOHL1dx9dJsFVPPoDs0CxlANbBq1arDO+yxIzrGOo6QvypJNEv/oZps3MTRQbYueGO23O7O6QybFf2O727VrbxejGmoMeMF1dLvUePmtbUpjzo9cXXFrdB3R3wfIHOqUxPmjUrUWEfv+SWuSMCfgTCpUtnzL1eyeBt5b7bqQsy8RX4MABSfs8I/P4EipTBfnLx2zfECfgvxPnN850hEYEua+AJ/ilLIlWRs17tj5vc4GuENEuThSp5pq5qOJgP+jDvuuYBM+PfUee8mQ3qab+Xze8xWI6icdG8P8Rwrug7IsP6pRvWfy48FgOKjDTScrKU8YzNX3yiiJ8cLeH9EryG+macMjC58Mq9X6febyQQsjsIUy/hPSiu/OmPA96Fpq3yHy6YUnNrhK47SYrM/QsZ6JrXvv6ht/0NtTVLbtlJb/zn1HsRtfK4/lYvPpwyUTW29j2HaAigppkevPJ464UZRxtbhws2JOIXkcTCKvMRgNBvACopQKK2k1Oo5ilw20fOW0bf6PDIMrxIxL1Et87uuqOebNQnjc3VLfCdxEbgZA03HcuTzVrXBTu+49Ah+Dv3Nu3nJS03U81F3xPiCZhnTSecrMf0yJWZcR4YZpMjhLjVqPkDHfZ7b92bbrsuujeMIqtLSvLcRnxO+FijFXTVjcQPmAoLSQonoQyKyohTA6QLOp8Q4GEUtnGaxgYlxMzIMFv9OGsbr9NyXyFw4xXyEDG4r/XsD/TtDP4/sLP4d/d99/Bx67v/S49/ImF6h97ZDHGenGwd8LI6ahDHR/3FbptpVleIUcLhRfCb0pTGHjV9eIgCUBpyWcectyTSHozIyEd5cgY2LU0we5GeDETvEkPk4ipeL0HP4ufw3/LfiNdiQqiSdOxDx2KWW8j7tGtL/n7w8ACgduOQuGdafxIRGhwsYqgJRVMWGLqYspLz3KP3G5+XlAUBpQenST3g9m+OFDFWFxI0EnrYS89yEFBCUNKql3yXmTzlcyFBli1NkGVU9oEQMTV4SAJQmtRHzw2pUf0Hcpne4oKHKlagPv6SRB9YD07uuxNZxoPRR43otD05jELpKNDVWxWWXk+YWxTLr5KUAQOlD0dXPa1di/KpaJO8Avk5fULeoAw3HycsAgPLAZTVcw5UunS5uqHLE0zt42oo76VntGqz/pjz9AJQXMKzKFqd/YtedlPdxNe65XJ52AMoTuqh/JSaMOlzsUPmKJ8fyeSXDes2d8MyZMXDNh+QpB6B80aL6TAy6V5DoPE6tf1S5htlgw7/KUw1A+cPF9uhCf5lThz0ufqh8FMtO/sxWkvCspvSvVp5iACoLxdLXiIWuTh0BKm1NGRVXvEh4MlrKe6E8rQBUJq5Iw68w8F5mEqkfR1TX8Wz1jDvpvUieTgAqm7NS+gmqpf9FjHs4dQ6oZMRLabgcjjhXcfMPMCpQlSgx4xd5LdwHHZS4PA4vUNfi5g414UlqSbNGnjoAqhDbeyhFWSt5yUYxCvhBDqK0j+t6iWknCfNpd9LTpiTM0+UZA6C64YXQWsLzMO/8AtMqnnghOpsUp31a0jNB52QWl3eWpwkAMIXSP+vz7lTjQxiEL6x4Wgnf7ROTPWPmc2RUIXfC45anBQCwN6b31J/kTnmXcnqIgfj8iQfQa5eRSXHxxJj5uho37qbU7+eIpgA4ALS4+Ust6X2MOxR/+2Ny6cFr50hKjZuvawnvWkoBdXXYe5r82AEABwpvj0Xf+ldQR7uHooBX3tgFeph3N8ZynrcVfUbZXbGzn5sWE6sK7lHJpOqW+L4oP2YAQK6pjXk/q0b1S6nTDZIed1O6yJECRwx82x0GRmKD2mnjWDYr/qzUqDlAjz+liPXT8uMEABQKLv7mintcFC1cR6njCiW609btK7IRGI/ROHbqChKnePxeuTCeMKgljbwh7NP8mVC616TEjLN5I1f5sQEASoFaSh1dlu7WUp5G6shJ6rR/4jGanXdQFibG42DlGIlRm7ntfBNiypzkjtWv0f/zpq5RLekxtISh8GchPxYAQDlwXtx3TE3S+yUysR9SZ76V0qFhxTL+SB3/Je703OF5vpdYZrLUl91iigyBDMDZMPKtGN+1I1NKZiMmMWFTjDtld4fm39HzXiRtU+OeOD3/ZpdlXFgb9556Zv9V75BvGwBQKZxOJqamfJ/UomaNljAvU6PmHDKyqBrVx3ktI5nAS+JWP4//SDObMg3+HRvdVJQmIjUn49ldbET8/KTcLZrSVsfXXyaiJUrnzH9Qex6nv8soUX2I2nULtfUS3gLLlfJ8bFpX09Hy7QAAqhU2gtqlvOVY/WlqtGGGFjcupIjs12Q6N5BptCuWPkiP95Am6XePCYOL6tt3MafdRWalWganbE/Scx+l15ugf9+pxIzF9HML/d7HayjpWOe7hhqmuQbrT61dYry/dviKo2SzACAOOeT/Awpy1x+UgQ53AAAAAElFTkSuQmCC"
  },
  "description": "A server-side tag template that reconfigures the data sent from your GA4 event tags, is claimed by the GA4 cliient, and then posted to Segment\u0027s Tracking Pixel API source.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "writeKey",
    "displayName": "API Write Key",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "To use the tracking pixel API, you need the write key."
  }
]


___SANDBOXED_JS_FOR_SERVER___

// Sandbox Javascript imports
const getAllEventData = require('getAllEventData');
const sendHttpRequest = require('sendHttpRequest');
const JSON = require('JSON');
const parseUrl = require('parseUrl');
const Math = require('Math');
const getTimestampMillis = require('getTimestampMillis');
const getRemoteAddress = require('getRemoteAddress');
const getRequestHeader = require('getRequestHeader');
const queryPermission = require('queryPermission');
//const sha256Sync = require('sha256Sync');
const logToConsole = require('logToConsole');
const getCookieValues = require('getCookieValues');
const makeNumber = require('makeNumber');
const setResponseStatus = require('setResponseStatus');
const setResponseBody = require('setResponseBody');
const setResponseHeader = require('setResponseHeader');
const getRequestPath = require('getRequestPath');
const getRequestQueryString = require('getRequestQueryString');
const sendHttpGet = require('sendHttpGet');
const toBase64 = require('toBase64');
const writeKey = data.writeKey;

/*function isAlreadyHashed(input){
  return input && (input.match('^[A-Fa-f0-9]{64}$') != null);
}


function hashFunction(input){
  if(input == null || isAlreadyHashed(input)){
    return input;
  }

  return sha256Sync(input.trim().toLowerCase(), {outputEncoding: 'hex'});
}*/


const eventModel = getAllEventData();
const event = {};
event.event_time = eventModel.event_time || (Math.round(getTimestampMillis() / 1000));
event.event_source_url = eventModel.page_location;
//event.search = parseUrl(event.event_source_url)["search"];
event.page_referrer = eventModel.page_referrer;
event.page_title = eventModel.page_title;
event.client_ip_address = getRemoteAddress;
event.client_user_agent = getRequestHeader('user-agent');
event.language = eventModel.language;
event.event_name = eventModel.event_name;
event.city = getRequestHeader('X-Appengine-City');
event.state = getRequestHeader('X-Appengine-Region');
event.country = getRequestHeader('X-Appengine-Country');

event.user_data = {};
// Default Tag Parameters
event.user_data.client_ip_address = eventModel.ip_override;
event.user_data.client_user_agent = eventModel.user_agent;


// Commmon Event Schema Parameters
event.user_data.em = eventModel['x-fb-ud-em'] ||
                        (eventModel.user_data != null ? eventModel.user_data.email_address : null);
event.user_data.ph = eventModel['x-fb-ud-ph'] ||
                        (eventModel.user_data != null ? eventModel.user_data.phone_number : null);

const addressData = (eventModel.user_data != null && eventModel.user_data.address != null) ? eventModel.user_data.address : {};
event.user_data.fn = eventModel['x-fb-ud-fn'] || addressData.first_name;
event.user_data.ln = eventModel['x-fb-ud-ln'] || addressData.last_name;
event.user_data.ct = eventModel['x-fb-ud-ct'] || addressData.city;
event.user_data.st = eventModel['x-fb-ud-st'] || addressData.region;
event.user_data.zp = eventModel['x-fb-ud-zp'] || addressData.postal_code;
event.user_data.country = eventModel['x-fb-ud-country'] || addressData.country;

// Segment Tracking Pixel Parameters
event.user_data.ge = eventModel['x-fb-ud-ge'];
event.user_data.db = eventModel['x-fb-ud-db'];
event.user_data.external_id = eventModel['x-fb-ud-external_id'];
event.user_data.subscription_id = eventModel['x-fb-ud-subscription_id'];
event.user_data.ajs_anonymous_id = getCookieValues('ajs_anonymous_id', true)[0];
event.client_id = eventModel['x-ga-js_client_id'];

event.custom_data = {};
event.custom_data.currency = eventModel.currency;
event.custom_data.value = eventModel.value;
event.custom_data.search_string = eventModel.search_term;
event.custom_data.order_id = eventModel.transaction_id;
event.custom_data.content_category = eventModel['x-fb-cd-content_category'];
event.custom_data.content_ids = eventModel['x-fb-cd-content_ids'];
event.custom_data.content_name = eventModel['x-fb-cd-content_name'];
event.custom_data.content_type = eventModel['x-fb-cd-content_type'];
event.custom_data.num_items = eventModel['x-fb-cd-num_items'];
event.custom_data.predicted_ltv = eventModel['x-fb-cd-predicted_ltv'];
event.custom_data.status = eventModel['x-fb-cd-status'];
event.custom_data.delivery_category = eventModel['x-fb-cd-delivery_category'];

const segmentJSON = {
  "anonymousId": event.user_data.ajs_anonymous_id,
  "event": event.event_name,
  "context": {
    "ip": event.client_ip_address,
    "locale": event.language,
    "location": {
      "city": event.city,
      "country": event.country,
      "region": event.state
      }
    },
  "page": {
    "path": event.event_source_url,
    "referrer": event.page_referrer,
    //"search": event.search,
    "title": event.page_title,
    "url": event.event_source_url,
  },
  "timeStamp": event.event_time,
  "type": "track",
  "userAgent": event.client_user_agent,
  "userId": event.client_id,
  "writeKey": writeKey
};
logToConsole(segmentJSON);

const segmentData = toBase64(JSON.stringify({
  "anonymousId": event.user_data.ajs_anonymous_id,
  "event": event.event_name,
  "context": {
    "ip": event.client_ip_address,
    "locale": event.language,
    "location": {
      "city": event.city,
      "country": event.country,
      "region": event.state
      }
    },
  "page": {
    "path": event.event_source_url,
    "referrer": event.page_referrer,
    //"search": event.search,
    "title": event.page_title,
    "url": event.event_source_url
  },
  "timeStamp": event.event_time,
  "type": "track",
  "userAgent": event.client_user_agent,
  "userId": event.client_id,
  "writeKey": writeKey
})
);
logToConsole(segmentData);

// Posting to tracking pixel API
const SEGMENT_ENDPOINT = 'https://api.segment.io';
const requestPath = '/v1/pixel/track';
const SEGMENT_URL = SEGMENT_ENDPOINT + requestPath;
const REQUEST_PARAMETERS = 'data=' + segmentData;
const graphEndpoint = [SEGMENT_URL,
                       REQUEST_PARAMETERS].join('?');
//const graphEndpoint = SEGMENT_URL + segmentData;
logToConsole(graphEndpoint);

//Send http GET request to Segment endpoint
if (queryPermission('send_http', graphEndpoint)) {
      sendHttpGet(graphEndpoint, (statusCode, headers, body) => {
      data.gtmOnSuccess();
      setResponseBody('Not Found');
      setResponseHeader('cache-control', headers['cache-control']);
      setResponseStatus(statusCode);
}, {headers: {'content-type': 'image/gif'}, timeout: 500});  //image/gif text/html; charset=UTF-8
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.segment.io/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ajs_anonymous_id"
              },
              {
                "type": 1,
                "string": "_ga"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: |-
  // Arrange
  const JSON = require('JSON');
  const Math = require('Math');
  const getTimestampMillis = require('getTimestampMillis');
  const sha256Sync = require('sha256Sync');

  // helper methods
  function hashFunction(input) {
    return sha256Sync(input.trim().toLowerCase(), {outputEncoding: 'hex'});
  }

  const testConfigurationData = {
    pixelId: '123',
    apiAccessToken: 'abc',
    testEventCode: 'test123',
    actionSource: 'source123'
  };

  const testData = {
    event_name: "Test1",
    event_time: "123456789",
    test_event_code: "test123",
    action_source: 'website',
    user_data: {
      ip_address: '1.2.3.4',
      user_agent: 'Test_UA',
      email: 'test@example.com',
      phone_number: '123456789',
      first_name: 'foo',
      last_name: 'bar',
      gender: 'm',
      date_of_brith: '19910526',
      city: 'menlopark',
      state: 'ca',
      country: 'us',
      zip: '12345',
      external_id: 'user123',
      subscription_id: 'abc123',
      fbp: 'test_browser_id',
      fbc: 'test_click_id',
    },
    custom_data: {
      currency: 'USD',
      value: '123',
      search_string: 'query123',
      transaction_id: 'order_123',
      content_category: 'testCategory',
      content_ids: ['123', '456'],
      content_name: 'Foo',
      content_type: 'product',
      contents:  [{'id': '123', 'quantity': 2}, {'id': '456', 'quantity': 2}],
      num_items: '4',
      predicted_ltv: '10000',
      delivery_category: 'home_delivery',
      status: 'subscribed',
    }
  };

  let inputEventModel = {
    'event_name': testData.event_name,
    'event_time': testData.event_time,
    'ip_override': testData.user_data.ip_address,
    'user_agent': testData.user_data.user_agent,
    'test_event_code': testData.test_event_code,
    'x-fb-ud-em': testData.user_data.email,
    'x-fb-ud-ph': testData.user_data.phone_number,
    'x-fb-ud-fn': testData.user_data.first_name,
    'x-fb-ud-ln': testData.user_data.last_name,
    'x-fb-ud-ge': testData.user_data.gender,
    'x-fb-ud-db': testData.user_data.date_of_brith,
    'x-fb-ud-ct': testData.user_data.city,
    'x-fb-ud-st': testData.user_data.state,
    'x-fb-ud-zp': testData.user_data.zip,
    'x-fb-ud-country': testData.user_data.country,
    'x-fb-ud-external_id': testData.user_data.external_id,
    'x-fb-ud-subscription_id': testData.user_data.subscription_id,
    'x-fb-ck-fbp': testData.user_data.fbp,
    'x-fb-ck-fbc': testData.user_data.fbc,
    'currency': testData.custom_data.currency,
    'value': testData.custom_data.value,
    'search_term': testData.custom_data.search_string,
    'transaction_id': testData.custom_data.transaction_id,
    'x-fb-cd-status': testData.custom_data.status,
    'x-fb-cd-content_category': testData.custom_data.content_category,
    'x-fb-cd-content_name': testData.custom_data.content_name,
    'x-fb-cd-content_type': testData.custom_data.content_type,
    'x-fb-cd-contents': testData.custom_data.contents,
    'x-fb-cd-num_items': testData.custom_data.num_items,
    'x-fb-cd-predicted_ltv': testData.custom_data.predicted_ltv,
    'x-fb-cd-delivery_category': testData.custom_data.delivery_category,
  };

  const expectedEventData = {
  'event_name': testData.event_name,
  'event_time': testData.event_time,
  'action_source': testConfigurationData.actionSource,
  'user_data': {
    'client_ip_address': testData.user_data.ip_address,
    'client_user_agent': testData.user_data.user_agent,
    'em': testData.user_data.email,
    'ph': testData.user_data.phone_number,
    'fn': testData.user_data.first_name,
    'ln': testData.user_data.last_name,
    'ct': testData.user_data.city,
    'st': testData.user_data.state,
    'zp': testData.user_data.zip,
    'country': testData.user_data.country,
    'ge': testData.user_data.gender,
    'db': testData.user_data.date_of_brith,
    'external_id': testData.user_data.external_id,
    'subscription_id': testData.user_data.subscription_id,
    'fbp': testData.user_data.fbp,
    'fbc': testData.user_data.fbc,
  },
    'custom_data': {
      'currency': testData.custom_data.currency,
      'value': testData.custom_data.value,
      'search_string': testData.custom_data.search_string,
      'order_id': testData.custom_data.transaction_id,
      'content_category': testData.custom_data.content_category,
      'content_name': testData.custom_data.content_name,
      'content_type': testData.custom_data.content_type,
      'contents': testData.custom_data.contents,
      'num_items': testData.custom_data.num_items,
      'predicted_ltv': testData.custom_data.predicted_ltv,
      'status': testData.custom_data.status,
      'delivery_category': testData.custom_data.delivery_category,
    }
  };

  mock('getAllEventData', () => {
    return inputEventModel;
  });

  const apiEndpoint = 'https://graph.facebook.com';
  const apiVersion = 'v10.0';
  const partnerAgent = 'gtmss-1.0.0-0.0.3';

  const routeParams = 'events?access_token=' + testConfigurationData.apiAccessToken;
  const requestEndpoint = [apiEndpoint,
                          apiVersion,
                          testConfigurationData.pixelId,
                          routeParams].join('/');

  let requestData = {
                      data: [expectedEventData],
                      partner_agent: partnerAgent,
                      test_event_code: testData.test_event_code
                     };
  const requestHeaderOptions = {headers: {'content-type': 'application/json'}, method: 'POST'};

  let actualSuccessCallback, httpBody;
  mock('sendHttpRequest', (postUrl, response, options, body) => {
    actualSuccessCallback = response;
    httpBody = body;
    actualSuccessCallback(200, {}, '');
  });


___NOTES___

Created on 8/5/2020, 10:20:28 AM


